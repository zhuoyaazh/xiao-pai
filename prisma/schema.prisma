generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  name              String?
  avatarUrl         String?
  bio               String?
  roles             String[]  @default(["buyer"])
  rating            Float?    @default(5.0)
  reviewCount       Int       @default(0)
  transactionCount  Int       @default(0)
  verificationStatus String   @default("email_verified") // email_verified, pending_ktm, verified, rejected
  ktmApprovedAt     DateTime?
  lat               Float?
  lng               Float?
  campusId          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  products          Product[]
  groupPurchases    GroupPurchase[]
  poParticipants    POParticipant[]
  proxyRequests     ProxyRequest[]
  proxyOffers       ProxyOffer[]
  assignedDriverJobs DriverJob[]
  acceptedHelperJobs HelperJob[] @relation("accepted_helpers")
  notifications     Notification[]
  reviews           Review[]
  transactions      Transaction[]
  wallet            Wallet?
  ktmVerification   KTMVerification?
  sellerOrders      Order[] @relation("seller")
  buyerOrders       Order[] @relation("buyer")
}

model KTMVerification {
  id                String    @id @default(cuid())
  userId            String    @unique
  selfiePath        String
  ktmPath           String
  status            String    @default("pending") // pending, approved, rejected
  rejectionReason   String?
  submittedAt       DateTime  @default(now())
  reviewedAt        DateTime?
  reviewedBy        String?
  createdAt         DateTime  @default(now())

  user              User      @relation(fields: [userId], references: [id])
}

model Wallet {
  id                String    @id @default(cuid())
  userId            String    @unique
  balanceCents      Int       @default(0) // in Rp × 100 for precision
  totalEarned       Int       @default(0)
  totalSpent        Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id])
}

model Transaction {
  id                String    @id @default(cuid())
  userId            String
  type              String    // top_up, purchase, driver_earning, helper_earning, refund, fee
  amount            Int       // in Rp × 100
  description       String?
  relatedId         String?   // link to PO/Order/HelperJob
  status            String    @default("completed") // pending, completed, failed
  createdAt         DateTime  @default(now())

  user              User      @relation(fields: [userId], references: [id])
}

model Product {
  id                String    @id @default(cuid())
  sellerId          String
  title             String
  description       String?
  price             Int       // in Rp × 100
  stock             Int       @default(0)
  images            String[]  @default([])
  category          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  seller            User      @relation(fields: [sellerId], references: [id])
}

model GroupPurchase {
  id                String    @id @default(cuid())
  sellerId          String
  title             String
  description       String?
  category          String    // Makanan, Barang, Jasa, Helper
  images            String[]  @default([])
  price             Int       // in Rp × 100
  minQty            Int
  maxQty            Int
  currentQty        Int       @default(0)
  deadline          DateTime
  status            String    @default("open") // open, filled, closed, completed, cancelled
  needsDriver       Boolean   @default(false)
  driverSlotsNeeded Int       @default(0)
  driverSlotsFilled Int       @default(0)
  needsHelper       Boolean   @default(false)
  helperNeeded      Int       @default(0)
  helperRatePerPerson Int?    // in Rp × 100
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  seller            User      @relation(fields: [sellerId], references: [id])
  participants      POParticipant[]
  driverJobs        DriverJob[]
}

model POParticipant {
  id                String    @id @default(cuid())
  poId              String
  buyerId           String
  qty               Int
  status            String    @default("joined") // joined, confirmed, delivered, cancelled
  joinedAt          DateTime  @default(now())

  po                GroupPurchase @relation(fields: [poId], references: [id])
  buyer             User      @relation(fields: [buyerId], references: [id])

  @@unique([poId, buyerId])
}

model DriverJob {
  id                String    @id @default(cuid())
  poId              String?
  sellerId          String
  acceptedDriverId  String?
  status            String    @default("open") // open, accepted, pickup, in_transit, delivered, cancelled
  pickupAddress     String?
  pickupLat         Float?
  pickupLng         Float?
  deliveryAddress   String?
  deliveryLat       Float?
  deliveryLng       Float?
  estimatedDistance Float?
  rewardRp          Int       // in Rp × 100
  isBigSplitSlot    Boolean   @default(false)
  bigSplitSlotNumber Int?
  bigSplitTotalSlots Int?
  createdAt         DateTime  @default(now())
  acceptedAt        DateTime?
  completedAt       DateTime?

  po                GroupPurchase? @relation(fields: [poId], references: [id])
  assignedDriver    User?     @relation(fields: [acceptedDriverId], references: [id])

  @@index([sellerId])
  @@index([acceptedDriverId])
}

model HelperJob {
  id                String    @id @default(cuid())
  sellerId          String
  title             String
  description       String?
  helpersNeeded     Int
  helpersFilled     Int       @default(0)
  ratePerPerson     Int       // in Rp × 100
  startTime         DateTime
  endTime           DateTime
  status            String    @default("open") // open, in_progress, completed, cancelled
  walletHeldAmount  Int       @default(0) // total Rp × 100 held in escrow
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  seller            User      @relation(fields: [sellerId], references: [id])
  acceptedHelpers   User[]    @relation("accepted_helpers")

  @@index([sellerId])
}

model ProxyRequest {
  id                String    @id @default(cuid())
  requesterId       String
  title             String
  description       String?
  estimatedBudget   Int?      // in Rp × 100
  deadline          DateTime?
  pickupLat         Float?
  pickupLng         Float?
  deliveryLat       Float?
  deliveryLng       Float?
  status            String    @default("open") // open, offered, assigned, completed, cancelled
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  requester         User      @relation(fields: [requesterId], references: [id])
  offers            ProxyOffer[]
}

model ProxyOffer {
  id                String    @id @default(cuid())
  proxyId           String
  responderId       String
  proposedPrice     Int?      // in Rp × 100
  message           String?
  status            String    @default("pending") // pending, accepted, rejected, completed
  createdAt         DateTime  @default(now())

  proxy             ProxyRequest @relation(fields: [proxyId], references: [id])
  responder         User      @relation(fields: [responderId], references: [id])
}

model Order {
  id                String    @id @default(cuid())
  buyerId           String
  sellerId          String
  poId              String?
  totalPrice        Int       // in Rp × 100
  fee               Int       // platform fee in Rp × 100
  status            String    @default("created") // created, confirmed, paid, shipped, delivered, completed, cancelled
  shippingAddress   String?
  shippingLat       Float?
  shippingLng       Float?
  paymentMethod     String?
  createdAt         DateTime  @default(now())
  completedAt       DateTime?

  buyer             User      @relation("buyer", fields: [buyerId], references: [id])
  seller            User      @relation("seller", fields: [sellerId], references: [id])
  items             OrderItem[]
}

model OrderItem {
  id                String    @id @default(cuid())
  orderId           String
  productTitle      String
  quantity          Int
  pricePerUnit      Int       // in Rp × 100
  totalPrice        Int       // in Rp × 100

  order             Order     @relation(fields: [orderId], references: [id])
}

model Review {
  id                String    @id @default(cuid())
  fromUserId        String
  targetUserId      String
  rating            Int       // 1-5
  text              String?
  context           String    // seller, driver, helper
  createdAt         DateTime  @default(now())

  fromUser          User      @relation(fields: [fromUserId], references: [id])
  targetUser        User      @relation(fields: [targetUserId], references: [id])
}

model Notification {
  id                String    @id @default(cuid())
  userId            String
  type              String    // po_joined, driver_accepted, helper_accepted, order_shipped, ktm_verified, job_cancelled, etc.
  title             String
  message           String?
  relatedId         String?
  read              Boolean   @default(false)
  createdAt         DateTime  @default(now())

  user              User      @relation(fields: [userId], references: [id])
}
